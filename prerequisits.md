# IMCYTO-dev

# Pipeline Documentation

-> HAVE ANOTHER DOCUMENT AS OUTPUTS.MD FOR THE OUTPUT FILES (CELLMASK, CSV) ETC WITH PIPELINE REPORTS AT THE END AS OTHER OUTPUTS (CAN COPY THE EXPLANATION FROM HARSHIL'S OTHER PROJECTS IN GITHUB

## Introduction:

This is an automated pipeline for preprocessing and segmenting imaging data from Imaging Mass Cytometry to obtain single cell information. 

This pipeline was written by Harshil Patel and Nourdine Bah at the Francis Crick Institute, using dockers/singularity/nextflow É to package together various image analysis tools É batch processing/parallelised/fast/flexible 

This pipeline is designed to run on a server/cluster without the need to pre-install any of the software packages. However, to modify/customise the pipeline, one needs to install the [CellProfiler(v3.1.8)](https://cellprofiler.org/ 'CellProfiler') and [Ilastik(v1.3.3)](https://www.ilastik.org/ 'Ilastik') softwares on a local machine (see **Pipeline adaptations** section).  

The concept of the stepwise image segmentation using a pixel classifier (Ilastik) to generate a membrane probability map combined with CellProfiler modules for subsequent single cell mask generation, is based on the analysis pipeline as described by the Bodenmiller group [(Zanotelli & Bodenmiller, Jan 2019)](https://github.com/BodenmillerGroup/ImcSegmentationPipeline/blob/development/documentation/imcsegmentationpipeline_documentation.pdf). 
The plugins supplied with the pipeline constitute the minimal requirements to generate a single cell mask. A more refined and comprehensive pipeline will be uploaded in due course.

## Pipeline summary:

1. Generate .tiff files from image acquisition output: Open .mcd or .txt files and contained ROIs and save individual .tiff files for channels with names matching those defined in a metadata.csv file into corresponding folders – full_stack for all channels being analysed in single cell expression analysis; ilastik_stack for channels being used to segment cells (IMCTools)
2. Preprocess full_stack images: Apply preprocessing filters to all .tiff files in the full_stack subfolder and save (CellProfiler – full_stack_preprocessing.cppipe)
3. Generate a cell map from ilastik_stack images: Merge .tiff images from the ilastik_stack subfolder to obtain an RGB image of cell nuclei and membranes and save as a composite.tiff (CellProfiler – ilastik_stack_preprocessing.cppipe)
4. Apply pixel classification to the composite cell map: Use composite.tiff to classify pixels as membrane, nuclei or background, and save probability maps as .tiffs (Ilastik)
5. Generate a single cell mask: Use probability .tiffs and preprocessed full_stack .tiffs for single cell segmentation to generate a cell mask (CellProfiler – segmentation.cppipe)
6. Output single cell expression data: Overlay cell mask onto full_stack tiff images to extract single cell information generating a csv file (CellProfiler – segmentation.cppipe)

## Pipeline workflow schematic:
 
[Workflow schematic](images/schematic.pdf)

## Pipeline prerequisites: 
- .mcd or .txt data file generated by the Hyperion without any spaces in the file name. Associated antibody panel should contain metal and antibody information in the form of ‘metal_antibody’.
- metadata.csv file containing your antibody panel to identify which corresponding .tiff files are to be put into full_stack and ilastik_stack folders (example shown in schematic). File should contain only three columns titled ‘metal’, ‘full_stack’ and ‘ilastik_stack’. ‘metal’ column should contain all the metals used in your antibody panel. ‘full_stack’ and ‘ilastik_stack’ columns should be used to identify which metals to include using boolean labelling (1 = use or 0 = don’t use).
- ‘NamesAndTypes’ module in all CellProfiler cppipe files (see 'Pipeline adaptations') will need to be edited to match your antibody panel and desired markers to identify cell nuclei and membranes. Other recommended changes to the pipeline are outlined ‘Pipeline details’ section.

## Pipeline adaptations:
- To view and edit the .cppipe files, download CellProfiler (v3.1.8) as well as the custom plugins created by Bodenmiller group (found here: https://github.com/BodenmillerGroup/ImcPluginsCP). Your own custom plugins can also be used. Open CellProfiler>Preferences and change ‘CellProfiler plugins directory’ path to where you stored the custom plugins. When saving, make to sure export the file as a .cppipe and to name the files as either ‘full_stack_preprocessing’, ‘ilastik_stack_preprocessing’ or ‘segmentation’ in line with the schematic above. 
- If you use any custom modules in any of the CellProfiler .cppipe files, make sure to add the python script into the ‘plugins/cp_plugins’ directory before running the pipeline (described below – ‘Running the pipeline’).
The pipeline is packaged with a pre-trained Ilastik pixel classifer but to train a classifier using your own dataset download Ilastik (v1.3.3), you will need to input desired RGB images in .tiff format and use ‘membrane’, ‘nuclei’ and ‘background’ labels to train your classifer. The input image should be the output of ‘ilastik_stack_preprocessing’. When selecting export settings select source as ‘Probabilities’, transpose axis order to ‘cyx’ and export output file as ‘tiff sequence’ to generate probability maps. The Ilastik file should be titled ‘ilastik_training_params.ilp’.- 

## Pipeline details:
Each step of the pipeline as depicted in the schematic is broken down and explained below, with the inputs and outputs highlighted.

### 1.IMCTools
**Input:** .mcd file/.txt file/.tiff files and metadata.csv file.
- Opens .mcd files and contained ROIs or opens .txt files, and converts each channel into individual .tiff files.
- If .tiff files are already present then this conversion step is skipped ?
- Uses metadata.csv file to sort .tiffs into into corresponding folders (full_stack/ilastik_stack).

**Output:** full_stack and ilastik_stack folders containing .tiffs

### 2.full_stack_preprocessing
**Input:** full_stack of .tiff images generated by IMCTools step
- This step selects all images in full_stack folder and sequentially processes them through various filtering methods.
- Current modules used: 

- These image filtering parameters can be changed by opening the file in CellProfiler.
- To keep your data raw, uncheck all the modules except ‘SaveImages’. This will save the unchanged input images into the correct place for the next step in the pipeline.
- Make sure to export a .cppipe file titled ‘full_stack_preprocessing’.

**Output:** full_stack folder containing processed .tiffs

### 3.ilastik_stack_preprocessing
**Input:** ilastik_stack of .tiff images generated by IMCTools step
- This step first selects specific files by finding matching names and labels them as either ‘membrane’ and ‘nuclei’. These images are then filtered and used to create an RGB composite image.
- Current modules used: 

- Open .cppipe file in CellProfiler to change names of input images in ‘NamesAndTypes’. Select markers that are representative of total membranes and cell nuclei. If one marker does not cover all cell type membranes, then various membrane markers can be merged by adding in an ‘ImageMath’ module to create a total membrane image, this image will need to be titled ‘membrane’.
- Further parameters can be customised, such as the filtering methods and parameters.
- Make sure to export a .cppipe file titled ‘ilastik_stack_preprocessing’.

**Output:** ilastik_stack folder containing a .tiff image titled ‘composite’

### 4.Ilastik_training_params
**Input:** RGB composite.tiff generated by ilastik_stack_preprocessing step
- Pixels are classified into three sets: membrane, nuclei and background by Ilastik using a pretrained classifer to generate a probability map of each.
- If required, the ilastik classifier can be retrained using a new dataset. These inputs should be the output composite image of ‘ilastik_stack_preprocessing’ step. When selecting export settings, select source as ‘Probabilties’, transpose axis order to ‘cyx’ and export output file as ‘tiff sequence’ to generate probability maps.
- Make sure to save ilastik classifier as ‘ilastik_training_params.ilp’.
- **Skip ilastik** option needs to be explained, as well as option to create empty/dummy ilastik/full stack cpppipe files if theyre not needed.

**Output:** three .tiff images titled ‘composite_Probabilities_’ ending in either 0 (for membrane), 1 (for nuclei) or 2 (for background)

### 5.segmentation
**Input:** preprocessed full stack of .tiff images generated by full_stack_preprocessing step and ‘composite_Probabilities_’ ending in 0 and 2 generated by ilastik step
- Open .cppipe file in CellProfiler to change names of input images in ‘NamesAndTypes’ to match your antibody panel, making sure to keep ‘_Probabilities_0’ as prob_membrane and ‘_Probabilities_2’ as prob_background.
- Current modules:

- You may need to adapt parameters present in ‘IdentifyPrimaryObjects’ and ‘IdentifySecondaryObjects’ modules to best suit your data. Common changes include typical diameter size in pixels of nuclear objects, thresholding strategy and method to distinguish clumped objects.
- Within ‘MeasureObjectIntensity Multichannel’ you will need to select images that you would like the intensity to be measured for.
- Further parameters can be changed, such as the desired measurements to export in ‘ExportToSpreadsheet’. Currently this pipeline exports data only for each cell object: area, mean intensity, object center location and object number.
- Make sure to export a .cppipe file titled ‘segmentation’.

**Output:** tiff image titled ‘Cells_mask’ and ‘Cells.csv’ file containing data
Comment: We use the merged DNA1/DNA2 images directly to identify the nuclei as primary objects, as we find that works well for us. Alternatively, one can opt for using the nuclei probability output (‘_Probabilities_1) from Ilastik to identify the nuclei as primary objects.

## Running the pipeline:
To run the pipeline, you will need to login into cluster … 
The .mcd file and metadata.csv should be put together in a folder titled ‘mcd’. A ‘plugins’ folder should contain all three CellProfiler files (i.e. full_stack_preprocessing.cppipe, ilastik_stack_preprocessing.cppipe, segmentation.cppipe), ilastik (ilastik_training_params.ilp) parameters file as well as any extra custom CellProfiler modules (.py) in ‘cp_plugins’ folder. The run_imcyto script should be put along with these folders. Once you are ready to run the pipeline excute the sh run.imcyto command, from within the main experiment folder.

**Example folder structure:**

[Example folder structure](images/example_folder_structure.png)

## How the pipeline runs:
Pull latest version from Github, docker containers, online/offline, run pipeline... 

## Pipeline reporting:
Once your pipeline has run successfully it will generate a range of reports alongside the pipeline outputs …
Example image of what the output folder structure looks like?

## Common errors and solutions:
- When the pipeline fails to run, first try to rerun it with command -resume
- The most common source of error is in the naming of the channels. Check the metadata.csv and the CellProfiler 'NamesandTypes' module. Make sure all metal names are correct and unambiguous (eg CD4 will find both CD4 and CD44 in 'NamesandTypes'). 
- For ROIs larger than ~2000-2000um the pipeline may struggle/fail to compete due to reaching memory capacity during ‘IdentifyObjects’ modules in ‘segmentation.cppipe’. As a workaround for this we recommend adding in a ‘Crop’ module before identifying objects to crop your images into two. Make sure to duplicate any subsequent modules and adjust input names as required.

## Other related software packages:
- MCDTM Viewer software provided by the Hyperion imaging system allows users to visualise, review and export .mcd image files.
- Fiji-ImageJ can also be used to view .mcd files but requires downloading IMCTools plugin. This plugin allows the .mcd file to be viewed as an image5D with your antibody markers as individual channels that can be toggled on/off.
- Additionally, QuPath, can also be used for visualisation with the added benefit of viewing all channels at once in a mini viewer panel.

## Hyperlinks:
- Zanotelli & Bodenmiller, Jan 2019: https://github.com/BodenmillerGroup/ImcSegmentationPipeline/blob/development/documentation/imcsegmentationpipeline_documentation.pdf 
- CellProfiler: https://cellprofiler.org/
- CellProfiler Bodenmiller custom plugins: https://github.com/BodenmillerGroup/ImcPluginsCP 
- Ilastik: https://www.ilastik.org/
- MCD Viewer: https://www.fluidigm.com/software 
- Fiji-ImageJ: https://imagej.net/Fiji 
- IMCTools: https://github.com/BodenmillerGroup/imctools
- QuPath: https://qupath.github.io/ 

